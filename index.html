<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Game Factory</title>
  <style>
    :root{--bg:#0b0f17;--panel:#10172a;--text:#eaf0ff;--muted:#98a8c7;--border:rgba(255,255,255,.10)}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{padding:16px;display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}
    .wrap{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;padding:0 16px 16px}
    @media (max-width: 980px){.wrap{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .head{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .body{padding:12px}
    button,input,select,textarea{
      border:1px solid var(--border);background:rgba(0,0,0,.25);color:var(--text);
      border-radius:12px;padding:10px 12px;font-size:13px
    }
    button{cursor:pointer;font-weight:700}
    button:hover{border-color:rgba(122,167,255,.55);background:rgba(122,167,255,.12)}
    textarea{width:100%;min-height:70px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{flex:1 1 220px;display:flex;flex-direction:column;gap:6px}
    iframe{width:100%;height:min(68vh,640px);border:0;background:#05070c}
    .frameWrap{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#05070c}
    .slots{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px}
    @media (max-width: 980px){.slots{grid-template-columns:repeat(5,minmax(0,1fr))}}
    @media (max-width: 620px){.slots{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .slot{padding:10px;border-radius:14px;border:1px solid var(--border);background:rgba(0,0,0,.20);cursor:pointer;min-height:78px;display:flex;flex-direction:column;justify-content:space-between}
    .slot:hover{border-color:rgba(122,167,255,.55);background:rgba(122,167,255,.10)}
    .slot.active{border-color:rgba(122,167,255,.80);background:rgba(122,167,255,.16)}
    .slotNum{color:var(--muted);font-size:12px;font-weight:800}
    .slotTitle{font-size:12px;font-weight:800;line-height:1.2}
    .slotMeta{color:var(--muted);font-size:10px;line-height:1.2}
    .status{padding:10px 12px;border:1px dashed rgba(255,255,255,.16);border-radius:14px;background:rgba(0,0,0,.18);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>AI Game Factory</h1>
      <div class="muted">Click Generate ‚Üí loads a brand-new game in the sandboxed iframe. Save into 60 slots (device-local).</div>
    </div>
    <div class="muted" id="hint"></div>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="head">
        <div>
          <div style="font-weight:900;font-size:13px">Current Game</div>
          <div class="muted" id="currentTitle">None loaded.</div>
        </div>
        <div class="row">
          <button id="gen">‚ú® Generate (AI)</button>
          <button id="save">üíæ Save to Slot</button>
          <button id="view">üìÑ View HTML</button>
          <button id="clear">üßπ Clear</button>
        </div>
      </div>
      <div class="body">
        <div class="status">
          <div>
            <div style="font-weight:900;font-size:12px" id="statusLabel">Ready</div>
            <div class="muted" id="statusMsg">Set your Worker URL, then generate a game.</div>
          </div>
          <div class="muted">Runs in sandbox: <b>allow-scripts</b> only</div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div class="field" style="flex:2 1 360px">
            <label class="muted">Optional idea</label>
            <textarea id="idea" placeholder="e.g., neon pinball, cozy fishing, rhythm dodger, etc."></textarea>
          </div>
          <div class="field">
            <label class="muted">Difficulty</label>
            <select id="difficulty">
              <option>easy</option>
              <option selected>normal</option>
              <option>hard</option>
              <option>insane</option>
            </select>
          </div>
          <div class="field">
            <label class="muted">Genre</label>
            <select id="genre">
              <option selected>surprise</option>
              <option>arcade</option>
              <option>puzzle</option>
              <option>runner</option>
              <option>shooter</option>
              <option>strategy</option>
              <option>rhythm</option>
              <option>physics</option>
            </select>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="field">
          <label class="muted">Worker URL (your AI endpoint)</label>
          <input id="workerUrl" placeholder="https://your-worker-name.your-subdomain.workers.dev" />
          <div class="muted">Tip: this gets saved in your browser.</div>
        </div>

        <div style="height:12px"></div>

        <div class="frameWrap">
          <iframe id="frame" sandbox="allow-scripts"></iframe>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="head">
        <div>
          <div style="font-weight:900;font-size:13px">Save Slots (60)</div>
          <div class="muted">Stored in localStorage (per device/browser). Export/Import available.</div>
        </div>
        <div class="row">
          <button id="export">‚¨áÔ∏è Export</button>
          <button id="import">‚¨ÜÔ∏è Import</button>
          <button id="wipe">üî• Wipe</button>
        </div>
      </div>

      <div class="body">
        <div class="row">
          <div class="field">
            <label class="muted">Selected slot</label>
            <input id="selected" disabled value="1" />
          </div>
          <div class="field">
            <label class="muted">Rename selected slot</label>
            <input id="rename" placeholder="Type name‚Ä¶" />
          </div>
          <button id="renameBtn">‚úèÔ∏è Rename</button>
          <button id="delBtn">üóëÔ∏è Delete</button>
        </div>

        <div style="height:12px"></div>
        <div id="slots" class="slots"></div>
      </div>
    </section>
  </div>

<script>
  const SLOTS = 60;
  const LS_SAVES = "aigf_saves_v1";
  const LS_WORKER = "aigf_worker_url_v1";

  const el = {
    hint: document.getElementById("hint"),
    workerUrl: document.getElementById("workerUrl"),
    idea: document.getElementById("idea"),
    difficulty: document.getElementById("difficulty"),
    genre: document.getElementById("genre"),
    gen: document.getElementById("gen"),
    save: document.getElementById("save"),
    view: document.getElementById("view"),
    clear: document.getElementById("clear"),
    frame: document.getElementById("frame"),
    statusLabel: document.getElementById("statusLabel"),
    statusMsg: document.getElementById("statusMsg"),
    currentTitle: document.getElementById("currentTitle"),
    slots: document.getElementById("slots"),
    selected: document.getElementById("selected"),
    rename: document.getElementById("rename"),
    renameBtn: document.getElementById("renameBtn"),
    delBtn: document.getElementById("delBtn"),
    exportBtn: document.getElementById("export"),
    importBtn: document.getElementById("import"),
    wipeBtn: document.getElementById("wipe"),
  };

  let saves = loadSaves();
  let selected = 0;
  let current = null; // {title, html, createdAt}

  el.workerUrl.value = localStorage.getItem(LS_WORKER) || "";
  el.workerUrl.addEventListener("change", () => {
    localStorage.setItem(LS_WORKER, el.workerUrl.value.trim());
    setHint();
  });

  function setHint(){
    const u = el.workerUrl.value.trim();
    el.hint.textContent = u ? "Worker: " + u : "Set Worker URL to enable AI";
  }
  setHint();

  function setStatus(a,b){ el.statusLabel.textContent=a; el.statusMsg.textContent=b; }
  function setBusy(b){
    el.gen.disabled=b; el.save.disabled=b; el.view.disabled=b; el.clear.disabled=b;
  }

  function loadSaves(){
    try{
      const raw = localStorage.getItem(LS_SAVES);
      if(!raw) return Array.from({length:SLOTS}, () => null);
      const arr = JSON.parse(raw);
      return Array.from({length:SLOTS}, (_,i) => arr?.[i] ?? null);
    }catch{
      return Array.from({length:SLOTS}, () => null);
    }
  }
  function persist(){ localStorage.setItem(LS_SAVES, JSON.stringify(saves)); }

  function renderSlots(){
    el.slots.innerHTML = "";
    for(let i=0;i<SLOTS;i++){
      const s = saves[i];
      const d = document.createElement("div");
      d.className = "slot" + (i===selected ? " active" : "");
      d.onclick = () => selectSlot(i);

      const top = document.createElement("div");
      top.style.display="flex";
      top.style.justifyContent="space-between";
      top.style.gap="10px";

      const num = document.createElement("div");
      num.className="slotNum";
      num.textContent = String(i+1).padStart(2,"0");

      const title = document.createElement("div");
      title.className="slotTitle";
      title.textContent = s?.title || "Empty";

      top.appendChild(num); top.appendChild(title);

      const meta = document.createElement("div");
      meta.className="slotMeta";
      if(s){
        const dt = new Date(s.createdAt || Date.now());
        meta.textContent = `${dt.toLocaleDateString()} ${dt.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"})}`;
      } else meta.textContent = "‚Äî";

      d.appendChild(top);
      d.appendChild(meta);
      el.slots.appendChild(d);
    }
  }

  function selectSlot(i){
    selected = i;
    el.selected.value = String(i+1);
    renderSlots();
    const s = saves[i];
    if(s){
      runGame(s);
      setStatus("Loaded", `Slot ${i+1}: "${s.title}"`);
    }else{
      setStatus("Selected", `Slot ${i+1} is empty. Generate then Save.`);
    }
  }

  function runGame(game){
    current = game;
    el.currentTitle.textContent = `${game.title}`;
    el.frame.srcdoc = game.html;
  }

  el.clear.onclick = () => {
    current = null;
    el.currentTitle.textContent = "None loaded.";
    el.frame.srcdoc = "";
    setStatus("Cleared", "Game cleared.");
  };

  el.view.onclick = () => {
    if(!current?.html){ setStatus("No game", "Generate or load a game first."); return; }
    const blob = new Blob([current.html], {type:"text/html"});
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank", "noopener,noreferrer");
  };

  el.save.onclick = () => {
    if(!current){ setStatus("Nothing to save", "Generate or load a game first."); return; }
    saves[selected] = { ...current, createdAt: Date.now() };
    persist();
    renderSlots();
    setStatus("Saved", `Saved to slot ${selected+1}.`);
  };

  el.renameBtn.onclick = () => {
    const name = (el.rename.value || "").trim();
    if(!name) { setStatus("Name missing","Type a name first."); return; }
    if(!saves[selected]) { setStatus("Empty slot","Nothing to rename."); return; }
    saves[selected].title = name;
    persist();
    el.rename.value = "";
    renderSlots();
    setStatus("Renamed", `Slot ${selected+1} renamed.`);
  };

  el.delBtn.onclick = () => {
    if(!saves[selected]) { setStatus("Already empty","That slot is empty."); return; }
    if(!confirm(`Delete slot ${selected+1}?`)) return;
    saves[selected] = null;
    persist();
    renderSlots();
    setStatus("Deleted", `Slot ${selected+1} cleared.`);
  };

  el.exportBtn.onclick = () => {
    const blob = new Blob([JSON.stringify({version:1, exportedAt:Date.now(), saves}, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "aigf_saves.json";
    a.click();
  };

  el.importBtn.onclick = () => {
    const inp = document.createElement("input");
    inp.type="file";
    inp.accept="application/json";
    inp.onchange = async () => {
      const f = inp.files?.[0];
      if(!f) return;
      try{
        const data = JSON.parse(await f.text());
        if(!Array.isArray(data?.saves)) throw new Error("Invalid file");
        saves = Array.from({length:SLOTS}, (_,i)=> data.saves[i] ?? null);
        persist();
        renderSlots();
        setStatus("Imported","Saves imported.");
      }catch(e){
        setStatus("Import failed", e.message || "Could not import.");
      }
    };
    inp.click();
  };

  el.wipeBtn.onclick = () => {
    if(!confirm("Wipe ALL 60 slots?")) return;
    saves = Array.from({length:SLOTS}, ()=> null);
    persist();
    renderSlots();
    setStatus("Wiped","All slots cleared.");
  };

  el.gen.onclick = async () => {
    const worker = el.workerUrl.value.trim();
    if(!worker){
      setStatus("Missing Worker URL", "Paste your Worker URL first.");
      return;
    }

    setBusy(true);
    setStatus("Generating‚Ä¶", "Asking AI for a brand-new game‚Ä¶");

    try{
      const resp = await fetch(worker, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          idea: el.idea.value || "",
          difficulty: el.difficulty.value,
          genre: el.genre.value
        })
      });

      const data = await resp.json().catch(() => null);

      if(!resp.ok){
        console.error(data);
        throw new Error(data?.error || "Worker request failed");
      }

      if(!data?.html || !data?.title) throw new Error("Bad response from Worker.");

      current = { title: String(data.title), html: String(data.html), createdAt: Date.now() };
      runGame(current);
      setStatus("Generated", `Loaded "${current.title}". Save it to a slot if you like it.`);
    }catch(e){
      console.error(e);
      setStatus("Failed", e.message || "Could not generate.");
    }finally{
      setBusy(false);
    }
  };

  // Init
  renderSlots();
  selectSlot(0);
  setStatus("Ready", "ai-game-worker.victorismakov.workers.dev");
</script>
</body>
</html>
